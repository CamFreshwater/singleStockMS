## Results 

```{r loadSimRunData, include=FALSE}
## Simulation ran in varyAllocation_mainSimRun.R. Also includes example figures
simParTrim <- simPar %>%
  filter(nameOM %in% c("ref", "enRoute"),
         benchmark == "stockRecruit")
scenNames <- unique(simParTrim$scenario)
dirNames <- sapply(scenNames, function(x) paste(x, unique(simParTrim$species), 
                                                sep = "_"))

#ID stocks included in CU-specific analyses
cuPar <- read.csv(here("data/fraserCUparsNEW.csv"), stringsAsFactors = F)
summCUs <- cuPar %>% 
  filter(manUnit == "Summ") %>% 
  mutate(abbStkName = abbreviate(stkName, minlength = 4)) %>% 
  select(abbStkName) %>% 
  unlist()

agVarsToPlot <-  c("medRecRY", "medSpawners", "ppnCULower", 
                   "medCatch", "stabilityCatch", "medER")

agDat <- buildDataAgg(dirNames, agVars =  agVarsToPlot, 
                      keyVarName = "ppnMixed") %>%
  mutate(mp = case_when(
    str_detect(mp, "genPA") ~ "Generic",
    str_detect(mp, "TAM") ~ "TAM"
  ), 
  labelledVar = var) %>%
  mutate(mp = as.factor(mp), 
         labelledVar = fct_recode(labelledVar, 
                                  "Aggregate\nReturn Abundance" = "medRecRY",
                                  "Aggregate\nSpawner Abundance" = 
                                    "medSpawners",
                                  "Proportion of CUs\nAbove Cons. BM" = 
                                    "ppnCULower",
                                  "Aggregate\nCatch" = "medCatch",
                                  "Catch\nStability" = "stabilityCatch",
                                  "Median\nExploitation Rate" = "medER")) 

refDat <- agDat %>% 
  filter(om == "ref", 
         mp == "Generic") 
```

Relatively large allocations to mixed- instead of single-stock fisheries resulted in declines in aggregate conservation-based performance metrics, including median return abundance, median spawner abundance, and the mean proportion of CUs above their biological benchmark ($S_{con}$) (Fig. \@ref(fig:aggDot)a-c). Conversely median aggregate catch and aggregate catch stability were maximized at intermediate allocations to mixed-stock fisheries (Fig. \@ref(fig:aggDot)d,e). These impacts on conservation- and catch-based metrics were driven by differences in realized exploitation rates, which increased with mixed-stock fishery allocations (Fig. \@ref(fig:aggDot)f).

```{r aggDot, warnings=FALSE, messages=FALSE, fig.cap="Changes in aggregate conservation- and catch-based performance metrics across a range of fishery allocations, i.e. range of proportional allocation of mixed- to single-stock where 1 and 0 are fully mixed- and fully single-stock fisheries, respectively. Points represent medians and whiskers represent 90th percentile intervals among Monte Carlo trials."}
# Fig. 1 - Dot plots
colPal <- viridis::viridis(length(levels(refDat$ppnMixed)), begin = 0, 
                           end = 1, option = "plasma")
names(colPal) <- levels(refDat$ppnMixed)

panelLabs <- data.frame(lab = c("a)", "b)", "c)", "d)", "e)", "f)"),
                        var = factor(agVarsToPlot, 
                                     levels = unique(agVarsToPlot)))

agDotPlotList <- lapply(seq_along(agVarsToPlot), function(x) {
  dum <- refDat %>% 
    filter(var == agVarsToPlot[x])
  p <- ggplot(dum, aes(x = ppnMixed, y = avg, ymin = lowQ, ymax = highQ,
                          fill = ppnMixed)) +
    ylim(0.85 * min(dum$lowQ), max(dum$highQ)) +
    labs(x = "", y = unique(dum$labelledVar)) +
    geom_pointrange(shape = 21, fatten = 3, size = 2,
                    position = position_dodge(width = 0.65)) +
    geom_text(data = panelLabs %>% filter(var == agVarsToPlot[x]),
              mapping = aes(x = 0.9, y = min(0.85 * dum$lowQ), label = lab,
                            vjust = 0),
              show.legend = FALSE, inherit.aes = FALSE, size = 7) +
    scale_fill_manual(guide = FALSE, values = colPal)
  if (unique(dum$var) %in% c("medRecRY", "medSpawners", "ppnCULower")) {
    p <- p +
      theme_sleekX(position = "top", axisSize = 15)
  } else {
    p <- p +
      theme_sleekX(position = "bottom", axisSize = 15)
  }
  return(p)
})

library(ggpubr)
panelFig <- ggarrange(agDotPlotList[[1]], agDotPlotList[[2]],
                              agDotPlotList[[3]],
                  agDotPlotList[[4]], agDotPlotList[[5]], agDotPlotList[[6]],
                  ncol = 3, nrow = 2, align = "v", heights = c(0.85, 1.1))
annotate_figure(panelFig, bottom = text_grob("Proportion Mixed-Stock TAC",
                                             size = 17, vjust = -1))
```

```{r recDecline, include=FALSE}
f <- function(ppnM, V = "medRecRY") {
  refDat %>% 
    filter(var == V, ppnMixed == ppnM) %>% 
    select(avg) %>% 
    as.numeric()
}
recDecline <- round((f(ppnM = "0") - f(ppnM = "0.5")) / f(ppnM = "0"), 
                    digits = 2) * 100
ppnDecline <- round((f(ppnM = "0", V = "ppnCULower") - f(ppnM = "0.5", 
                                                         V = "ppnCULower")) / 
                      f(ppnM = "0", V = "ppnCULower"), 
                    digits = 2) * 100
```

At the aggregate scale, intermediate mixed-stock allocations appeared to optimize trade-offs between conservation- and catch-based objectives. For example, splitting TAC evenly between mixed- and single-stock fisheries led to high median catches, while resulting in relatively modest declines in median return abundance (`r recDecline`% decline; Fig. \@ref(fig:aggTO) left) and the mean proportion of CUs above their biological benchmark (`r ppnDecline`% decline; Fig. \@ref(fig:aggTO) right).

```{r aggTO, warnings=FALSE, messages=FALSE, fig.cap="Trade-offs between aggregate conservation- and catch-based performance metrics across a range of mixed-stock fishery allocations. Points represent medians and whiskers represent 90th percentile intervals among Monte Carlo trials."}
# Fig. 2 - Agg tradeoff plots
consVec <- c("medRecRY", "ppnCULower")
catchVec <- rep(c("medCatch"), times = length(consVec))
conLabels <- c("Median Aggregate\nReturn Abundance", 
               "Proportion of Stocks\nAbove Benchmark")

toAgList <- lapply(seq_along(consVec), function(x) {
  p <- plotAgTradeoff(refDat %>% select(-labelledVar), consVar = consVec[x], 
                      catchVar = catchVec[x],
                      facet = NULL, shape = NULL, showUncertainty = TRUE,
                      xLab = "", yLab = conLabels[x], 
                      legendLab = "Proportion\nMixed-Stock\nTAC",
                      axisSize = 15, dotSize = 6, legendSize = 14,
                      lineSize = 1.5, scaleAxis = "fixed")
  return(p)
})
panelTO <- ggarrange(toAgList[[1]], toAgList[[2]], ncol = 2, nrow = 1, 
                  common.legend = TRUE, legend = "right")
annotate_figure(panelTO, bottom = text_grob("Median Aggregate Catch", 
                                              size = 15, vjust = -0.5))
```

Equivalent trade-offs were more nuanced at the scale of individual CUs. For example, abundant and relatively productive stocks either were insensitive (Harrison CU, Fig. \@ref(fig:cuTO)) or responded positively (Chilko CU, Fig. \@ref(fig:cuTO)) to increases in mixed-stock fishery allocations. In both cases, single-stock fisheries are rarely closed (because the CU remained above its biological benchmark), resulting in exploitation rates that are independent of fishery allocation. In the case of the Chilko CU, the rare single-stock closures have negative impacts because they result in large spawner abundances and reduced abundance in subsequent years due to density dependent effects (i.e. overescapement). <!-- CF comment: Is this sufficiently intuitive or should it be illustrated with a supplementary SR figure.--> 

More commonly, however, larger mixed-stock fishery allocations resulted in  declines in return abundance and ultimately catch due to recruitment overfishing (Fig. \@ref(fig:cuTO)). These effects were particularly severe in the smallest stock, Raft, which exhibited strong declines when mixed-stock fishery allocations exceeded 25% (Fig. \@ref(fig:cuTO)). For other CUs declines in catch occurred when mixed-stock allocations exceeded 50%.

```{r cuTO, warnings=FALSE, messages=FALSE, fig.cap="Trade-offs between CU-specific return abundance and catch across a range of mixed-stock fishery allocations. Points represent medians and whiskers represent 90th percentile intervals among Monte Carlo trials."}
cuVarsToPlot <- c("medRecRY", "medSpawners", "medCatch", "ppnYrsUpper",
                  "medTotalER")

cuDat <- buildDataCU(dirNames = dirNames, 
                     cuVars = cuVarsToPlot,
                     keyVarName = "ppnMixed", 
                     selectedCUs = summCUs) %>% 
  mutate(ppnMixed = as.factor(ppnMixed),
         mp = case_when(
           str_detect(mp, "genPA") ~ "Generic",
           str_detect(mp, "TAM") ~ "TAM"
         ),
         cuName = fct_recode(cuName, "L. Stuart" = "L.St", "Stellako" = "Stll",
                        "Quesnel" = "Qsnl", "Chilko" = "Chlk", "Harrison" = 
                          "Hrrs")) %>% 
  select(-plotOrder, -muName) %>% 
  filter(om == "ref",
         mp == "Generic")

p <- plotCUTradeoff(cuDat, consVar = "medRecRY", catchVar = "medCatch",
               facet = "cu", panel = NULL, showUncertainty = TRUE,
               xLab = "Median Catch", yLab = "Median Return Abundance",
               legendLab = "Proportion\nMixed-Stock\nTAC", lineSize = 0.75, 
               main = FALSE, axisSize = 15, dotSize = 4)
p[[1]]
```

```{r heatMapdata, include=FALSE}
heatMapDat <- readRDS(here::here("outputs", "generatedData", "heatMapDat.rds"))
prodDat <- heatMapDat %>% 
  dplyr::filter(scenario == "Prod")

plotHeat <- function(plotVar = "medRecRY", legName = "rec", bins = 30,
                     dat = agDat) {
  dum <- dat %>%
    filter(var == plotVar) %>% 
    mutate(xAxis = case_when(
      scenario == "Synch" ~ synch,
      scenario == "Prod" ~ prod,
    ))
  dumInterp <- akima::interp(x = dum$xAxis, y = dum$ppnMixedNew, 
                             z = dum$avg, nx = bins, ny = bins) %>% 
    akima::interp2xyz() %>% 
    as.data.frame()
  names(dumInterp) <- c("opMod", "ppnMixedNew", "value")
  ggplot(dumInterp, aes(x = opMod, y = ppnMixedNew)) + 
    geom_tile(aes(fill = value)) + 
    geom_contour(aes(z = value), color = "black") +
    viridis::scale_fill_viridis(name = legName, option = "plasma") +
    theme_sleekX(legendSize = 1.1) +
    theme(axis.title.x = element_blank(),
          axis.title.y = element_blank())
}
```

Changes in population productivity moderated the effect of fishery allocations on conservation- and catch-based metrics. At high levels of productivity, increasing single-stock fishery allocations resulted in relatively large increases in the proportion of stocks above $S_{con}$; however as productivity declines the relative difference between predominantly mixed- and single-stock fishery decreases (Fig. \@ref(fig:prodTO) left). Conversely, median catch is maximized at intermediate allocations when productivity is high, but as productivity declines predominantly single-stock fisheries begin to provide greater catches (Fig. \@ref(fig:prodTO) right). 

```{r prodTO, warnings=FALSE, messages=FALSE, fig.cap="Impacts of changes in productivity on median proportion of stocks above their biological benchmark (left) and median aggregate catch (right) across across a range of mixed-stock fishery allocations. Productivity is moderated by a scalar applied uniformly to all CU's most recent estimate of productivity."}
dumLab <- expression(atop('Ppn. Stocks', 'Above S'[con]))
ppnProd <- plotHeat(plotVar = "ppnCULower", 
                    legName = dumLab,
                    dat = prodDat)
catchProd <- plotHeat(plotVar = "medCatch", legName = "Catch",
                    dat = prodDat)

panelHeat <- ggpubr::ggarrange(ppnProd, catchProd,  ncol = 2, nrow = 1, 
                               widths = c(1.15, 1))
annotate_figure(panelHeat, bottom = text_grob("Productivity Scalar", size = 15,
                                              vjust = -0.5),
                left = text_grob("Proportion Mixed-Stock TAC", size = 15, 
                                 rot = 90))
```

Trade-offs between mixed- and single-stock fisheries were sensitive to the structure of the harvest control rule. For example, a more precautionary mixed-stock harvest control rule, which replicated the framework currently used by Fraser River sockeye salmon managers, still resulted in larger catches in mixed-stock fisheries (relative to single-stock), but did not exhibit evidence of recruitment overfishing (i.e. no backward bending curve) (Fig. \@ref(fig:hcrTO)). Additionally, declines in conservation-based performance metrics with predominantly mixed-stock fisheries were more modest than those observed with the reference, generic mixed-stock harvest control rule (Fig. \@ref(fig:hcrTO)).

```{r hcrTO, echo=FALSE, warning=FALSE, warnings=FALSE, messages=FALSE, fig.cap="Comparison of generic multi-stock harvest control rule and a more precautionary total allowable mortality (TAM) rule. Points represent medians and whiskers represent 90th percentile intervals among Monte Carlo trials."}
refDat2 <- agDat %>% 
  filter(om == "ref") %>% 
  mutate(hcr = mp)

plotAgTradeoff(refDat2 %>% select(-labelledVar), consVar = "medRecRY", 
               catchVar = "medCatch", facet = NULL, shape = "hcr",
               showUncertainty = TRUE, xLab = "Median Aggregate Catch", 
               yLab = "Median Aggregate Return", 
               legendLab = "Proportion\nMixed\nStock TAC",
               axisSize = 15, dotSize = 6, legendSize = 13, lineSize = 1,
               scaleAxis = "fixed")
```

The timing of en-route mortality also altered the trade-offs associated with fishery allocations. When en-route mortality occurred before single-stock fisheries, median aggregate return abundance in predominantly single-stock fisheries declined relative to the reference scenario (Fig. \@ref(fig:erTO)). Additionally median aggregate catch in single-stock fisheries was considerably lower (Fig. \@ref(fig:hcrTO)). 

```{r erTO, warnings=FALSE, messages=FALSE, fig.cap="The impact of en route mortality timing, relative to single-stock fisheries, on trade-offs between aggregate return abundance and catch. Points represent medians and whiskers represent 90th percentile intervals among Monte Carlo trials."}
enRouteDat <- agDat %>% 
  filter(mp == "Generic") %>% 
  mutate(om = case_when(
    str_detect(om, "enRoute") ~ "En-Route Mortality\nBefore Fishery",
    str_detect(om, "ref") ~ "En-Route Mortality\nAfter Fishery"
  ))
conLabels2 <- c("Median Aggregate\nReturn Abundance", 
               "Proportion of CUs\nAbove Benchmark")

plotAgTradeoff(enRouteDat %>% select(-labelledVar), consVar = "medRecRY", 
               catchVar = "medCatch", facet = "om", 
               shape = NULL, showUncertainty = TRUE, 
               xLab = "Median Aggregate Catch", 
               yLab = "Median Aggregate Return", 
               legendLab = "Proportion\nMixed\nStock TAC",
               axisSize = 15, dotSize = 6, legendSize = 13, lineSize = 1,
               scaleAxis = "fixed")
```
