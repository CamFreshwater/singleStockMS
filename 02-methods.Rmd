```{r loadPackagesAndData, include=FALSE}
simPar <- read.csv(here::here("data", "manProcScenarios",
                        "fraserMPInputs_varyAllocationVaryMixHCR.csv"),
                   stringsAsFactors = F)
cuPar <- read.csv(here::here("data/summOnlyCUPars.csv"), stringsAsFactors = F)
srDat <- read.csv(here::here("data/fraserRecDatTrim.csv"), stringsAsFactors = F)
catchDat <- read.csv(here::here("data/fraserCatchDatTrim.csv"), 
                     stringsAsFactors = F)
```

# METHODS 

## 2.1 Sockeye salmon biology, fisheries and data sources

The closed-loop simulation model is structured to reflect the life history of sockeye salmon and is parameterized using data from stocks within the Fraser River. Sockeye salmon is an anadromous, semelparous fish distributed throughout the northern Pacific. Populations in southern British Columbia typically rear as juveniles in freshwater lakes for one-two years, mature in the Gulf of Alaska, and return to spawn as two- to five-year olds [@Burgner1991]. Under Canada’s Wild Salmon Policy (WSP), Pacific salmon status is assessed at the scale of conservation units (CUs), defined as “a group of wild salmon sufficiently isolated from other groups that, if lost, is unlikely to recolonize naturally within an acceptable timeframe” [@DFO2005]. While CUs are not precisely equivalent to stocks, we use the latter term throughout to place our analysis in a more generic context.

The Fraser River aggregate is Canada’s largest sockeye salmon run, but is increasingly vulnerable to a range of threats including anthropogenic development, overexploitation, and climate change [@Cohen2012; @COSEWIC2017]. Productivity throughout the system declined in the 1990s [@Peterman2012; @Freshwater2018], resulting in frequent fishery closures and an emergency federal inquiry into the causes of the declines [@Cohen2012]. While specific stocks have shown signs of recovery in recent years, recruitment continues to be highly variable and numerous stocks remain at very low productivity levels, with ten of 24 assessed as at risk of extinction [@COSEWIC2017]. 

Although Fraser River sockeye salmon status is assessed at the stock level, the majority of harvest occurs in the marine environment and is managed using four run timing aggregates (management units; MUs). As a result, harvest effort can be constrained at the scale of MUs, but not individual stocks. Since MUs can include stocks ranging in status from abundant to severely depleted, increasing the stock-selectivity of harvest rates may provide an opportunity to increase the probability of rebuilding depleted stocks, while minimizing socio-economic impacts.  

```{r calcTS, include=FALSE}
stks <- unique(cuPar$stk)
d <- srDat %>% 
  filter(stk %in% stks,
         !is.na(rec2)) %>% 
  select(stk, yr) %>% 
  group_by(stk) %>% 
  summarise(min = min(yr), 
            max = max(yr))
maxY <- min(d$max)
minY <- max(d$min)
diff <- maxY - minY
```

We focused our analysis on the summer-run MU, which contains six stocks that vary in status and cyclic behavior. The stock-recruit time series cover `r diff` years, begining in `r minY` and ending in `r maxY`. Note that throughout this manuscript we use the term *return* abundance to refer to the sum of catch and escapement in a given return year, where escapement is defined as the number of fish that have escaped all fisheries. In comparison, we use the term *recruit* abundance to refer to the sum of catch and escapement produced by spawners from a given brood year (see @Grant2011 for details).

## 2.2 Forward simulation

Closed-loop simulations provide a powerful tool to evaluate the trade-offs among objectives associated with different management frameworks and the consequences of uncertainty [@Punt2016]. Typically closed-loop simulations contain two main components. First, the operating model represents the attributes of the system that are largely beyond the immediate control of managers (e.g. population dynamics of stocks, including declines in productivity associated with climate change). The second model component, the management procedure, represents dimensions of the fishery under more direct anthropogenic control. Examining the performance of different management procedures can be used to evaluate the impact of different harvest control rules [@Cooke1999; @Holt2008; @Collie2012] or the relative accuracy of assessments [@KHolt2011; @Holt2015], while different operating models can be used to evaluate the impact of dynamic processes, such as changes in natural mortality and recruitment deviations [@Holt2010; @Forrest2018; @Freshwater2019]. 

### 2.2.1 Reference operating model

The structure of the operating model is equivalent to that in Freshwater et al. (2019) and is described in detail in Appendix S1. Briefly the dynamics of each Fraser River stock were simulated using an age-structured, Ricker spawner-recruit model [@Ricker1975]

Equation 1  $$R_{i,y} = S_{i,y} e^{\alpha_i - \beta_iS_{i,y} + w_{i,y}}$$

where $i$ represents a stock, $y$ is a given brood year, $R$ the number of recruits, and $S$ the number of spawners. The parameter $\alpha$ represents the number of recruits produced per spawner at low abundance, while $\beta$ is the density-dependent parameter that represents the reciprocal of the number of spawners that maximizes recruitment. This model captures the natural mortality that occurs between spawning and adult recruitment to coastal fisheries, prior to spawning in freshwater. The Ricker model is commonly represented in the linear form 

Equation 2  $$log_e(\frac{R_{i,y}}{S_{i,y}}) = \alpha_i - \beta_iS_{i,y} + w_{i,y}$$

where $w_{i,y} \sim \text{normal}(0, \sigma^2)$.

Recruitment deviations $w_{i,y}$ in the forward simulation incorporated temporal autocorrelation and covariance among stocks (Appendix S1). The operating model also included interannual variation in age-at-maturity (Appendix S1). 

A subset of stocks within the Fraser River are cyclic, exhibiting large differences in abundance at four-year intervals. Abundant year classes, typically referred to as dominant as opposed to off-cycle, contribute disproportionately to aggregate returns [@Grant2011]. We used a Larkin model, an extension of the Ricker model that accounts for delayed-density dependent effects by incorporating three additional $\beta$ parameters and spawner abundances from the preceding three years [@Larkin1971], to simulate the dynamics of cyclic stocks (two of six stocks in the Summer Run MU; Appendix S1).

To account for observed productivity declines in Fraser River sockeye salmon [@Peterman2012; @Freshwater2018], we used a recursive Bayes stock-recruitment model to estimate non-stationary $\alpha$ parameters from the historical time series. To parameterize the forward simulation model we estimated median parameter sets (i.e. median $\alpha$ from the most recent time step and corresponding $\beta$ and $\sigma$) using stock-specific spawner-recruit models (details of model structure and fitting in Appendix S1).

The simulation model included multiple sources of mortality in addition to the natural mortality implicitly incorporated in the spawner-recruit relationship. First, we simulated harvest $C$ in mixed- and single-stock fisheries (details in *2.2.2 Management Procedure*). We also simulated stock-specific en route mortality $D$, which accounts for natural mortality during upstream migration, unreported harvest, post-release fishing mortality, and error between in-river and terminal estimates of spawner abundance [@Grant2011]. In the reference case en route mortality was applied after both mixed- and single-stock fisheries occurred (but see *2.2.3 Alternative Operating Models*). We modeled en route mortality as a stochastic process that varied by stock as a function of escapement

Equation 3 $$ D_{i,t} \sim \text{lognormal}(d_{i}(R'_{i,t} - C_{i,t}), \sigma^2_{mort,i}) $$

where $d$ represents the mean and $\sigma_{mort}$ the standard deviation of the en route mortality rate for stock $i$. En route mortality was parameterized using observed differences in estimated abundance between in-river and spawning ground sampling sites (2000-2016; Pacific Salmon Commission, unpublished data). Stock-specific mean mortality rates, $d$, ranged from 0.04-0.60, with standard deviations, $\sigma_{mort}$, ranging from 0.17-0.48.

Spawner abundance $S$ was then calculated as 

Equation 4 $$ S_{i,t} = R'_{i,t} - C_{i,t} - D_{i,t} .$$

### 2.2.2 Management procedure

The management procedure contained a harvest component, representing the dynamics of two distinct fisheries, as well as an observation and assessment component that simulated the data collection process and assessed status relative to management targets.

We modeled tradeoffs between mixed- and single-stock fisheries by calculating target catch at an individual stock level and allocating a fixed proportion of that target catch to each fishery. Although the stock-selectivity of a fishery can theoretically be increased using a variety of spatial or temporal restrictions, we modeled fully segregated and sequential fisheries (i.e. mixed-stock fisheries followed by single-stock fisheries). This structure maximized contrast between different mixed- and single-stock allocations and is plausible for salmon where freshwater fisheries in terminal areas have been developed for several populations [@DFO2017a].

We modeled catch in each fishery using a generic, abundance-based harvest control rule with three distinct steps. First, an MU-level target exploitation rate $u_{targ}$ was calculated based on aggregate abundance, using a generic harvest control rule proposed under Fisheries and Oceans Canada's Precautionary Approach Framework [@DFO2009]. Briefly, $u_{targ}$ ranged between 10% (a minimum exploitation rate approximating incidental harvest) and the exploitation rate at maximum sustainable yield, ${u}_{MSY}$, as a function of aggregate return abundance relative to two fishery reference points. The reference points are spawner abundances (40% and 80%) relative to the spawner abundance estimated to lead to maximum sustainable yield (described in detail in Appendix S1).

Second, we calculated the stock-specific target catch for each fishery ($C_{targ,mix,i}$ and $C_{targ,sing,i}$) as

Equation 7a $$ C_{targ,mix,i,t} = pu_{targ}R'_{i,t} $$
Equation 7b $$ C_{targ,sing,i} = (1-p)u_{targ}R'_{i,t} $$

where $u_{targ}$ is the target exploitation rate, $R'$ is return abundance, and $p$ is the proportion of the total catch allocated to the mixed-stock fishery. We varied $p$ from 0 to 1, in increments of 0.25, to evaluate the impact of changing the relative proportion of catch harvested in mixed- vs. single-stock fisheries. Note that $C_{targ}$ calculations assume that stock-specific return abundance is known without error, which may result in overestimates of single-stock fishery performance (see Appendix S1 for details).

Third, we reduced the impacts of fisheries on depleted populations by closing single-stock fisheries when median observed spawner abundance, $\tilde{S}_{med}$, was below a biological benchmark consistent with relatively severe conservation concern, $S_{con}$. In the case of non-cyclic stocks (modeled with a Ricker relationship) the single-stock harvest control rule was

Equation 8a $$ C_{targ,sing,i,t} = 0 \text{ if  } \tilde{S}_{med,i} < S_{con,i} $$
Equation 8b $$ \tilde{S}_{i,t} \sim \text{lognormal}(S_{i,t}, \sigma^2_{obs}). $$ 

Observed spawner abundance, $\tilde{S}_{i,t}$, will differ from true spawner abundance due to measurement error, small sample sizes, and other estimation processes. We defined $S_{con}$ in the context of Canada's Wild Salmon Policy, setting $S_{con,i}$ to the abundance that will result in spawner abundance leading to ${S}_{MSY}$ in one generation in the absence of fishing mortality, ${S}_{gen,i}$ [@DFO2005; @Holt2009]. In the case of cyclic stocks (modeled with a Larkin relationship) the single-stock fishery was closed (i.e. $C_{targ,sing,i,t} = 0$) unless the current simulation year was a dominant cycle line (defined by calendar year) and the previous dominant return year's spawner abundance was greater than ${S}_{gen,i}$ [@DFO2018a]. 

Realized catches in each fishery included outcome uncertainty (also referred to as implementation uncertainty or implementation error), which represents deviations between target and realized catches due to variation in forecast accuracy, catchability, enforcement, or unreported catch [@Holt2006]. We simulated realized exploitation rates $u$ as random variables sampled from a beta distribution:

Equation 9a $$ u_{i,t} \sim \text{beta}(a_{i,t}, b_{i,t})$$

where the shape parameters $a$ and $b$ were calculated from target exploitation rates $u_{targ}$ and empirically-based estimates of among-year variation in deviations between target and realized exploitation rates, $\sigma_{out}$, as follows:

Equation 9b $$ a_{i,t} = u_{targ,i,t}^2 ({\frac{1 - u_{targ,i,t}} {\sigma_{out}^2}} - {\frac{1}{u_{targ,i,t}}}) $$
Equation 9c $$ b_{i,t} = a_{i,t}({\frac{1} {u_{targ,i,t}}} - 1).$$

We parameterized $\sigma_{out}$ using observed deviations between target and realized exploitation rates in mixed-stock fisheries for Fraser River sockeye salmon MUs between 2006 and 2017. We fixed $\sigma_{out}$ at $`r simPar[["mixOUSig"]][1]`$ for both mixed- and single-stock fisheries since there is no evidence that terminal fisheries currently operating have larger deviations from management targets than marine fisheries (J. Scroggie, DFO Fisheries management, *personal communication*). 

We note that Fraser River sockeye salmon are currently managed with a more conservative variable exploitation rate harvest control (total allowable mortality (TAM) rule), which attempts to account for cyclic abundance, overlapping run timings among MUs, en route mortality, and other system-specific management adjustments [@Pestal2011]. However the reference points associated with the TAM rule vary interannually and are informed by expert opinion, reducing its relevance to salmon fisheries in general. The TAM rule is summarized in Appendix S1 and we present the results of a secondary analysis comparing its performance to the generic HCR.

### 2.2.3 Alternative operating models

We evaluated the relative performance of various levels of single vs mixed-stock fisheries across two sets of alternative operating models. First, we incorporated alternate productivity regimes by applying a scalar (0.6 to 1.1 in increments of 0.05) to each stock's estimate of $\alpha$. The bounds of the scalar were chosen based on observed changes in productivity (mean ~30% decline during the time series, ranging from 54% decline to 53% increase). The scalar simulated hypothetical, additional future changes that might mirror those that have already occurred. Second, we tested the effect of the timing of en route mortality $D$ relative to single-stock harvest on the efficacy of single-stock fisheries. Specifically, we modeled the impact of single stock harvest that occurred after en route mortality

Equation 10 $$ C_{sing,i,t} = (R'_{i,t} - C_{mix,i,t} - D_{i,t})u_{sing,i,t}. $$

Thus spawner abundance was calculated as

Equation 11 $$ S_{i,t} = R'_{i,t} - C_{mix,i,t} - D_{i,t} - C_{sing,i,t}. $$

This modification is intended to represent a scenario where single-stock fisheries can only be developed in fully terminal areas. Such a scenario is particularly relevant to highly mixed-stock fisheries such as Fraser River, Bristol Bay, and Skeena River sockeye salmon because the large number of stocks and the overlap in migration timing among stocks [@Grant2011; @Walters2008; @Cunningham2019], will constrain the selectivity of fisheries that are not fully terminal. Since en route mortality can be considerable in certain years [@Grant2011; @Cooke2004], the abundance of fish available to harvest will be lower in terminal fisheries in those years relative to marine, altering trade-offs between conservation and catch objectives. 

Additionally, we completed sensitivity analyses to evaluate the impact of our assumptions about the magnitude of: temporal autocorrelation in recruitment deviations ($\tau$), error associated with estimating spawner abundance ($\sigma_{obs}$), fishery-specific outcome uncertainty ($\sigma_{out}$), and interannual variability in stochastic processes (age-at-maturity ($\gamma$) and en route mortality ($\sigma_{mort}$)) (Appendix S2).

### 2.2.4 Performance metrics

We considered a range of conservation- and catch-based performance metrics to determine how fishery allocations impact management performance (Table \@ref(tab:pmTable)). We evaluated both stock-specific and aggregate (i.e. summed or mean values within the MU) performance metrics because the relative impact of changes in exploitation rate and fishery allocation may differ between abundant and depleted stocks. The aggregate performance metrics account for all six stocks within the MU. We present median outputs among simulations for each performance metric, as well as the 5th and 95th percentiles.

```{r pmTable, results="asis"}
pmTable <- read.csv(here::here("data", "msTables", "pmTable.csv"))

k <- knitr::kable(pmTable, format = "pandoc", booktabs = TRUE, linesep = "",
                  caption = "Aggregate and stock-specific performance metrics.",
                  "latex") 
k <- kableExtra::kable_styling(k, font_size = 12)
k
```

We initialized the simulation with stock-specific time series of spawner and recruit abundance and ran the simulation for $`r simPar[["simYears"]][1]`$ years (approximately $`r round(simPar[["simYears"]][1]/4, 0)`$ generations). We summarized performance metrics across 1500 Monte Carlo trials (convergence occurred after approximately 1200). 