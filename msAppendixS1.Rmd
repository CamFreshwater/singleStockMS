---
header-includes:
  - \usepackage{caption}
output:
  word_document:
    fig_caption: yes
    reference_docx: templates/blankMS.docx
  # bookdown::pdf_document2:
  #   fig_caption: yes
  #   latex_engine: pdflatex
    # includes:
    #   in_header: preamble-latex.tex
csl: csl/ecology.csl
link-citations: no
bibliography: bib/ms_singleStock.bib
---

```{r setup, echo=FALSE, cache=FALSE, message=FALSE, results='hide', warning=FALSE}
# adjust as desired:
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>",
  fig.path = if (knitr:::is_latex_output()) "knitr-figs-pdf/" else "knitr-figs-docx/",
  cache.path = if (knitr:::is_latex_output()) "knitr-cache-tex/" else "knitr-cache-docx/",
  fig.asp = 0.618,
  fig.width = 9,
  out.width = "6in",
  echo = FALSE,
#  autodep = TRUE,
#  cache = TRUE,
  cache.comments = FALSE,
  dev = if (knitr:::is_latex_output()) "png" else "png",
  dpi = 180,
  fig.align = "center",
  fig.pos = "htb"
)
options(kableExtra.latex.load_packages = FALSE)
```

```{r load-libraries, cache=FALSE}
# add other packages here:
library(csasdown)
library(here)
library(tidyverse)
library(samSim)
library(knitr)
library(kableExtra)

simPar <- read.csv(here::here("data", "manProcScenarios",
                        "fraserMPInputs_varyAllocationVaryMixHCR.csv"),
                   stringsAsFactors = F)
cuPar <- read.csv(here::here("data/fraserCUPars.csv"), stringsAsFactors = F)
```

# Operating Model

## Larkin model

Cyclic salmon stocks are typically modeled using an adaptation of the Ricker model, the Larkin model, featuring delayed density-dependence parameters [@Larkin1971]:

Equation S1.1  $$log_{e}(\frac{R_{i,y}}{S_{i,y}}) = \alpha_i - \beta_{0,i}S_{i,y} - \beta_{1,i}S_{i,y-1} - \beta_{2,i}S_{i,y-2} - \beta_{3,i}S_{i,y-3} + w_{i,y}$$

where $i$ represents a stock, $y$ is a given brood year, $R$ the number of recruits, and $S$ the number of spawners. The parameter $\alpha$ represents the number of recruits produced per spawner at low abundance, while $\beta_{x}$ is the density-dependent parameter at time lag $x = $ 0, 1, 2, 3, 4. Stochastic recruitment deviations, $w_{i,y}$, are normally distributed with mean zero and variance $\sigma^2$. Fraser River sockeye salmon stocks modeled with a Larkin relationship contain one dominant and three off-cycle lines.

## Recursive Bayes stock-recruit model

We used a recursive Bayesian formulation of the Peterman et al. [-@Peterman2012] Kalman filter model, which accounts for temporal variability in the alpha parameter, to estimate Ricker and Larkin stock recruit parameters for each stock independently. The priors for most parameters were weakly informative (Table S1.1), except for $\alpha$ which was normally distributed with a mean and standard deviation taken from the posterior estimates of a stationary stock recruit analysis [@Freshwater2019]. We fit models using MCMC in JAGS [@Plummer2003] with the R package R2jags [@Su2015]. We confirmed model convergence using visual inspection of trace plots and Gelman-Rubin statistics. Each model run included four MCMC chains of 32,500 iterations, with a burn in of 15,000 and a thinning rate of 7.

```{r priorsTable, results="asis"}
priorsTable <- read.csv(here::here("data", "msTables", "priorsTable.csv"))
#add parameters 
parPriors <- c("ln$(\\alpha)$", "$S_{max}$", "$\\tau$", "$\\beta_{1-3}$")
dist <- c("normal$(\\alpha_{stat.}, \\sigma_{\\alpha_{stat.}})$",
          "lognormal(ln(max$(S_{obs.}), 1)$ truncated at 3 x max$(S_{obs.})$",
          "gamma(0.001, 0.001)",
          "uniform(0, 100")
priorsTable <- priorsTable %>% 
  mutate(Parameter = parPriors, 
         Prior.Distribution = dist)
csas_table(priorsTable,
  caption = "Table S1.1. Priors for recursive Bayes stock recruit models.",
  font_size = 20,
  col_names = c("Parameter", "Description", "Prior Distribution")
)
```

## En route mortality

En route mortality was parameterized using observed differences in estimated abundance between in-river and spawning ground sampling sites (2000-2016; Pacific Salmon Commission, unpublished data). Stock-specific mean mortality rates, $d$, ranged from 0.04-0.60, with standard deviations, $\sigma_{mort}$, ranging from 0.17-0.48.

## Recruitment deviations

Year- and stock-specific recruitment deviations $w_{i,y}$ in the forward simulation incorporated temporal autocorrelation and covariance in recruitment deviations among stocks

Equation S1.2a $$w_{i,y} = w_{i,y-1}\tau + r_{i,y}$$
Equation S1.2b $$r_i \sim MVN(0, \boldsymbol{\mathrm{V}})$$
Equation S1.2c $$\boldsymbol{\mathrm{V}} =
 \begin{bmatrix}
  \sigma'^2_1 & \rho\sigma'_1\sigma'_2 & \cdots & \rho\sigma'_1\sigma'_n \\
  \rho\sigma'_1\sigma'_2 & \sigma'^2_2 & \cdots & \rho\sigma'_2\sigma'_n \\
  \vdots  & \vdots  & \ddots & \vdots  \\
  \rho\sigma'_1\sigma'_n & \rho\sigma'_2\sigma_n & \cdots & \sigma'^2_n
 \end{bmatrix}$$
 
where $w_{i,y-1}$ represents recruitment deviations one year prior, $\tau$ represents an autoregressive lag-1 year (AR1) correlation coefficient, and $r_{i,y}$ represents multivariate normally distributed error with a standard deviation defined by the variance-covariance matrix $\boldsymbol{\mathrm{V}}$, dimensioned by the number of stocks $n$. $\rho$ represents the pairwise correlation coefficient among stocks and was set to $`r simPar[["correlCU"]][1]`$ based on the mean observed correlation in recruitment deviations in recent years. We adjusted estimates of $\sigma$ to account for $\tau$ using the transformation, $\sigma'^2 = \sigma^2(1-\tau^2 )$, where $\sigma^2$ is the variance derived from a model without autocorrelation and $\sigma'^2$ is the adjusted value [@Pestal2011]. $\tau$ was set to 0.2 based on evidence of weak autocorrelation in the residuals of stock-recruit models from preliminary analyses.

## Age-at-maturity

Although the majority of Fraser River sockeye salmon mature at age 4 (i.e. one winter as eggs, one winter as fry in lakes, and two ocean winters), smaller proportions mature at ages 2, 3, and 5, with age structure varying among stocks We modeled this process by calculating the number of individuals returning to spawn $R'_{i,t}$ in return year $t$ in stock as a function of the total number of adult recruits $R$ generated in previous brood years, multiplied by the proportion $p$ of fish that return at a given age $g$ 
Equation S2 $$ R'_{i,t} = R_{i,t-2}p_{2,i,t-2} + R_{i,t-3}p_{3,i,t-3} + R_{i,t-4}p_{4,i,t-4} + R_{i,t-5}p_{5,i,t-5}. $$

We incorporated multivariate logistic variation in the proportion of mature fish returning at each age

Equation S1.3 $$ p_{g,i,y} = \frac{ \overline{p}_{g,y} e^{\gamma_i \epsilon_{g,i,y}}} {\sum_{2}^{5} \overline{p}_{g,y} e^{\gamma_i \epsilon_{g,i,y}}} $$

```{r gammas, include=FALSE}
minGamma <- min(cuPar$tauCycAge)
maxGamma <- max(cuPar$tauCycAge)
```

where $y$ is the brood year (equal to $t-2$, $t-3$, $t-4$ or $t-5$ in Eqn. 4), the summation in the denominator is over ages g= 2 to 5, $\overline{p}_{g,y}$ is the stock-specific mean proportion of adult fish that return at a given age, $\gamma$ is a parameter controlling interannual variability in the proportion returning at each age, and $\epsilon_{g,i,y} \sim \text{normal}(0, 1)$ [@Schnute1995; @Holt2011]. We estimated stock-specific $\gamma_i$ parameters which scaled the size of deviations in equation (5) using a simple grid search of Fraser River sockeye salmon ages at maturity. Estimates of $\gamma_i$ ranged from $`r minGamma`$ - $`r maxGamma`$ among stocks.

# Management procedure

## Forecast error and outcome uncertainty

The simulation model assumes that total catch is split into stock-specific target catch, $C_{targ,i}$, proportional to each stock's abundance in a given year. Fisheries managers clearly do not have access to this information in-season, but in the case of mixed-stock fisheries the assumption is valid because fish are assumed to be harvested proportionally to their abundance and the data used to parameterize outcome uncertainty incorporated forecast error. In the case of single-stock fisheries fish are not harvested proportionally to their abundance, but their are no data available to parameterize the stock-specific forecast process independently of outcome uncertainty. Preliminary investigations, however, suggest that incorporating forecast error when allocating aggregate total allowable catch to stock-specific catch results in reduced performance of single-stock fisheries relative to mixed due to intermittent overharvest.

We parameterized $\sigma_{out}$ using observed deviations between target and realized exploitation rates in mixed-stock fisheries for Fraser River sockeye salmon MUs between 2006 and 2017. We fixed $\sigma_{out}$ at $`r simPar[["mixOUSig"]][1]`$ for both mixed- and single-stock fisheries since there is no evidence that terminal fisheries currently operating have larger deviations from management targets than marine fisheries (J. Scroggie, DFO Fisheries management, *personal communication*). 

## Harvest control rules

The simulation model generated target harvest rates (for both fisheries combined) using a generic, abundance-based harvest control rule (HCR) proposed under Fisheries and Oceans Canada's Precautionary Approach Framework [@DFO2017b]. Specifically a minimal exploitation rate (10%) approximating incidental harvest was applied when MU-level abundance was less than 40% of the spawner abundance that would lead to maximumum sustainable yield ($0.4{S}_{MSY}$). When abundance was greater than 80% of that spawner abundance ($0.8{S}_{MSY}$), the exploitation rate at maximum sustainable yield (approximated by ${u}_{MSY}$) was applied (Fig. S1.1). When return abundance was between these two reference points, the target exploitation rate was a linear function of abundance:

Equation S1.4 $$ u_{targ} = {u}_{MSY}({\frac{R' – 0.4{S}_{MSY}} {0.8{S}_{MSY} − 0.4{S}_{MSY}}}).$$

We calculated ${u}_{MSY}$ at the aggregate MU-level using the Lambert W function, $W(z)$ [@Scheuerell2016]:

Equation S1.5 $$ {u}_{MSY} = 1 - W(e^{1 - \alpha_m})$$

where $\alpha_m$ is an estimate of MU-level productivity calculated by fitting a Ricker model (Eq. 2 main text) to spawner and recruit abundance data summed among all summer-run stocks. All reference points were derived from aggregate benchmarks calculated after summing spawner and return abundances across stocks.

```{r genHCR, warnings=FALSE, messages=FALSE, fig.cap="Figure S1.1. Generic, abundance-based harvest control rule used to calculate target exploitation rates. Dashed vertical lines represent lower (red) and upper (green) fishery reference points equivalent to $0.4{S}_{MSY}$ and $0.8{S}_{MSY}$, respectively. The maximum exploitation rate is equal to ${u}_{MSY}$ (0.66 for the Summer Run MU aggregate). The inflection point in exploitation rate does not fall on the lower fishery reference point because we assumed that an exploitation rate less than 0.1 was not realistic given incidental harvest in other fisheries."}
cuPar <- read.csv(here::here("data/summOnlyCUPars.csv"), stringsAsFactors = F)
uMsy <- cuPar$uMSY[1]
lowFRP <- cuPar$lowFRP[1]
highFRP <- cuPar$highFRP[1]
ret = seq(0, 2, length.out = 999)
esc = rep(NA, length.out = 999)
hr = rep(NA, length.out = 999)
for (i in 1:length(ret)) {
  if (ret[i] < lowFRP) {
    hr[i] <- 0.1
  }
  if (ret[i] > lowFRP & ret[i] < highFRP) {
    hr[i] <- max(0.1, 
                 uMsy * ((ret[i] - lowFRP) / (highFRP - lowFRP))
                 )
  }
  if (ret[i] > highFRP) {
    hr[i] <- uMsy
  }
  esc[i] <- ret[i] - (ret[i] * hr[i])
}
plot(hr ~ ret, xlim=c(0, 2), ylim=c(0, 1), ylab = "", xlab = "", axes = F, 
     type ="l", lwd = 2)
axis(1, las = 1)
axis(2, las = 1)
mtext("Total Exploitation Rate", 2, line = 2.5)
mtext("Return Abundance (Millions)", 1, line = 2)
abline(v = lowFRP, col = "red", lty = 2, lwd = 2)
abline(v = highFRP, col = "darkgreen", lty = 2, lwd = 2)
```

We also evaluated the impact of an alternative HCR, a total allowable mortality (TAM) rule, intended to approximate the management framework currently used for Fraser River sockeye salmon. As with the reference HCR, the TAM rule specifies annual target harvest rates based on return abundance relative to two fishery reference points. Unlike the generic HCR, however, the TAM rule reference points differ among cycle lines and are derived using expert knowledge, and the maximum target harvest rates are lower (Table S2).

```{r frpTable, results="asis"}
frpTable <- read.csv(here::here("data", "msTables", "frpTable.csv"))
csas_table(frpTable,
  caption = "Table S2. Fishery reference points (FRP; in millions of fish) and maximum exploitation rates (ER) for the generic harvest control rule utilized in the main text and the total allowable mortality rule. Note that the first year of the simulation is on the 4th cycle line.",
  font_size = 20,
  col_names = c("Harvest Control Rule", "Cycle", "Low FRP", "High FRP", "Maximum Target ER")
)
```

The TAM rule also differs from the generic HCR due to three additional adjustments. First, the TAM rule includes a constant escapement goal above the lower fishery reference point, resulting in a curvilinear increase in target exploitation rates as abundance increases, rather than the linear increase in Fig. S1. Second, harvest rates are typically lowered due to anticipated en-route mortality. We simulated this process by applying an en-route mortality adjustment, _pMA_, that acts as a scalar on escapement goals (the difference between return size and target catch). Thus a _pMA_ equal to 0 results in no adjustment, while a _pMA_ equal to 1 results in a 100% increase in the escapement goal. We parameterized this model component by setting the _pMA_ equal to the median _pMA_ observed for the Summer Run MU since 2000. Third, harvest rates are adjusted annually to reduce incidental harvest of co-migrating MUs that are at low abundance. We excluded this adjustment because we only modeled one MU (Summer Run stocks).

_Literature Cited_