```{r loadPackagesAndData, include=FALSE}
simPar <- read.csv(here::here("data", "manProcScenarios",
                        "fraserMPInputs_varyAllocationVaryMixHCR.csv"),
                   stringsAsFactors = F)
cuPar <- read.csv(here::here("data/summOnlyCUPars.csv"), stringsAsFactors = F)
srDat <- read.csv(here::here("data/fraserRecDatTrim.csv"), stringsAsFactors = F)
catchDat <- read.csv(here::here("data/fraserCatchDatTrim.csv"), 
                     stringsAsFactors = F)
```

# METHODS 

## 2.1 Sockeye salmon biology and fisheries

The closed-loop simulation model reflects sockeye salmon life history and is parameterized using data from Fraser River stocks. Sockeye salmon is an anadromous, semelparous fish distributed throughout the northern Pacific. Populations in southern British Columbia typically rear as juveniles in freshwater lakes for one-two years, mature in the Gulf of Alaska, and return to spawn as two- to five-year olds [@Burgner1991]. Under Canada’s Wild Salmon Policy (WSP), Pacific salmon status is assessed at the scale of conservation units (CUs), genetically isolated groups of spawning populations [@DFO2005]. While CUs are not precisely equivalent to stocks, we use "stock" throughout to place our analysis in a more generic context.

The Fraser River aggregate is Canada’s largest sockeye salmon run, but is increasingly vulnerable to anthropogenic development, overexploitation, and climate change [@COSEWIC2017]. Productivity throughout the system declined in the 1990s [@Peterman2012; @Freshwater2018], resulting in frequent fishery closures and an emergency federal inquiry into the causes of the declines. While some stocks have shown signs of recovery in recent years, ten of 24 were recently assessed as at risk of extinction [@COSEWIC2017]. 

Although Fraser River sockeye salmon status is assessed at the stock level, the harvest is managed using four run timing aggregates (management units; MUs). As a result, harvest effort can be constrained at the MU-, but not the stock-specific, scale. Since MUs can include stocks ranging in status from abundant to severely depleted, increasing the stock-selectivity of harvest rates may provide an opportunity to increase the probability of rebuilding, while minimizing socio-economic impacts.  

```{r calcTS, include=FALSE}
stks <- unique(cuPar$stk)
d <- srDat %>% 
  filter(stk %in% stks,
         !is.na(rec2)) %>% 
  select(stk, yr) %>% 
  group_by(stk) %>% 
  summarise(min = min(yr), 
            max = max(yr))
maxY <- min(d$max)
minY <- max(d$min)
diff <- maxY - minY
```

We focused our analysis on the summer-run MU, which contains six stocks that vary in status. The stock-recruit time series cover `r diff` years, beginning in `r minY` and ending with the `r maxY` brood year. Note that throughout this manuscript we use *return* abundance to refer to the sum of catch and escapement in a given return year, where escapement is defined as the number of fish that have escaped all fisheries. In comparison, we use *recruit* abundance to refer to the sum of catch and escapement produced by spawners from a given brood year [@Grant2011].

## 2.2 Forward simulation

Closed-loop simulations provide a tool to evaluate the trade-offs among objectives associated with different management frameworks while accounting for uncertainty [@Punt2016]. Typically closed-loop simulations contain two main components. First, the operating model represents system attributes largely beyond the control of managers (e.g. population dynamics of stocks). The second component, the management procedure, represents dimensions of the fishery under anthropogenic control. Examining the performance of different management procedures can be used to evaluate the impact of different harvest control rules [@Cooke1999; @Holt2008; @Collie2012], while different operating models can be used to evaluate the impact of dynamic ecological processes, such as changes in natural mortality or recruitment deviations [@Holt2010; @Forrest2018; @Freshwater2019].

### 2.2.1 Reference operating model

The structure of the operating model is equivalent to that in Freshwater et al. (2019) and is described in detail in Appendix S1. Briefly the dynamics of each stock were simulated using an age-structured, Ricker spawner-recruit model [@Ricker1975]

Equation 1  $$log_e(\frac{R_{i,y}}{S_{i,y}}) = \alpha_i - \beta_iS_{i,y} + w_{i,y}$$

where $i$ represents a stock, $y$ a given brood year, $R$ the number of recruits, and $S$ the number of spawners. $\alpha$ represents the number of recruits produced per spawner at low abundance (in log space), while $\beta$ is the density-dependent parameter (i.e. the reciprocal of spawner abundance maximizing recruitment). Recruitment deviations $w_{i,y}$ are normally distributed with mean 0 and variance $\sigma_{i}^2$.

A subset of Fraser River stocks are cyclic, exhibiting large differences in abundance at four-year intervals. We used a Larkin model, an extension of the Ricker model that accounts for delayed-density dependent effects [@Larkin1971], to simulate the dynamics of cyclic stocks (two of six stocks in the Summer Run MU; Appendix S1).

To account for productivity declines in Fraser River sockeye salmon [@Peterman2012; @Freshwater2018], we used a recursive Bayes stock-recruitment model to estimate non-stationary $\alpha$ parameters from the historical time series. We parameterized the forward simulation model with median parameter sets (i.e. median $\alpha$ from the most recent time step and corresponding $\beta$ and $\sigma$) estimated from stock-specific models (Appendix S1).

The simulation model included multiple sources of mortality in addition to the natural mortality implicit in spawner-recruit relationships. First, we simulated harvest $C$ in mixed- and single-stock fisheries (details in *2.2.2 Management Procedure*). We also simulated stock-specific en route mortality $D$, which accounts for natural mortality during upstream migration, unreported harvest, post-release fishing mortality, and error between in-river and terminal estimates of spawner abundance [@Grant2011]. In the reference case en route mortality occurred after both mixed- and single-stock fisheries (but see *2.2.3 Alternative Operating Models*). We modeled en route mortality as a stock-specific, stochastic process

Equation 2 $$ D_{i,t} \sim \text{lognormal}(d_{i}(R'_{i,t} - C_{i,t}), \sigma^2_{mort,i}) $$

where $d$ represents the mean and $\sigma_{mort}$ the standard deviation of observed stock-specific en route mortality and $R'_{i,t}$ is return abundance (all age classes) to stock $i$ in return year $t$ (details in Appendix S1). 

Spawner abundance $S$ was then calculated as 

Equation 3 $$ S_{i,t} = R'_{i,t} - C_{i,t} - D_{i,t}.$$

Additional operating model components, including temporal autorcorrelation and among-stock covariance in simulated recruitment deviations $w_{i,y}$, as well as interannual variation in age-at-maturity, are described in Appendix S1.

### 2.2.2 Management procedure

The management procedure contained a harvest component, representing the dynamics of two distinct fisheries, as well as components that simulated data collection and assessed status relative to management targets.

We modeled tradeoffs between mixed- and single-stock fisheries by calculating target catch for each stock and allocating a fixed proportion of that target catch to each fishery (described in detail below). Although the stock-selectivity of a fishery can be increased using various spatial or temporal restrictions, we modeled fully segregated and sequential fisheries. This structure maximized contrast between different allocations and is plausible for salmon where terminal fisheries have been developed for several stocks [@DFO2017a].

We modeled catch in each fishery in three steps. First, an MU-level target exploitation rate $u_{targ}$ was calculated based on aggregate abundance, using a generic harvest control rule proposed under Fisheries and Oceans Canada's Precautionary Approach Framework [@DFO2009]. $u_{targ}$ ranged between 10% (a minimum exploitation rate approximating incidental harvest) and the exploitation rate at maximum sustainable yield, ${u}_{MSY}$, as a function of aggregate return abundance relative to two fishery reference points. The reference points are spawner abundances (40% and 80%) relative to the spawner abundance estimated to lead to maximum sustainable yield (Appendix S1).

Second, we calculated stock-specific target catch for each fishery ($C_{targ,mix,i}$ and $C_{targ,sing,i}$) by applying target exploitation rates to stock-specific return abundances as

Equation 4a $$ C_{targ,mix,i,t} = pu_{targ}R'_{i,t} $$
Equation 4b $$ C_{targ,sing,i,t} = (1-p)u_{targ}R'_{i,t} $$

where $u_{targ}$ is the target exploitation rate, $R'$ is return abundance, and $p$ is the proportion of the total catch allocated to the mixed- vs. single-stock fisheries. We varied $p$ from 0 to 1, in increments of 0.25, to evaluate the impact of changing the relative proportion of catch harvested in mixed- vs. single-stock fisheries. Note that $C_{targ}$ calculations assume that _proportional_ stock-specific return abundance is known without error, which may result in overestimates of single-stock fishery performance (see Appendix S1 for justification).

Third, we reduced fishery impacts on depleted populations by closing single-stock fisheries when median observed spawner abundance during the previous generation, $\tilde{S}_{med}$, was below a biological benchmark consistent with conservation concern, $S_{con}$. In the case of non-cyclic stocks (Ricker model) the single-stock harvest control rule was

Equation 5a $$ C_{targ,sing,i,t} = 0 \text{ if  } \tilde{S}_{med,i} < S_{con,i}, $$

where

Equation 5b $$ \tilde{S}_{i,t} \sim \text{lognormal}(S_{i,t}, \sigma^2_{obs}). $$ 

Observed spawner abundance, $\tilde{S}_{i,t}$, differs from true spawner abundance due to estimation processes. In the case of cyclic stocks (Larkin model) the single-stock fishery was closed ($C_{targ,sing,i,t} = 0$) unless the current simulation year was a dominant cycle line (defined by calendar year) and the previous dominant return year's spawner abundance was greater than ${S}_{con,i}$ [@DFO2018a]. We defined defined $S_{con,i}$ as the abundance that will result in spawner abundance leading to ${S}_{MSY,i}$ in one generation in the absence of fishing mortality, ${S}_{gen,i}$ [@Holt2009]. 

Realized catches included outcome uncertainty representing deviations between target and realized catches [@Holt2006]. We simulated realized exploitation rates $u$ using a beta distribution:

Equation 6a $$ u_{i,t} \sim \text{beta}(a_{i,t}, b_{i,t})$$

where $a$ and $b$ were calculated from target exploitation rates $u_{targ}$ and empirical estimates of deviations between target and realized exploitation rates, $\sigma_{out}$, as follows:

Equation 6b $$ a_{i,t} = u_{targ,i,t}^2 ({\frac{1 - u_{targ,i,t}} {\sigma_{out}^2}} - {\frac{1}{u_{targ,i,t}}}) $$
Equation 6c $$ b_{i,t} = a_{i,t}({\frac{1} {u_{targ,i,t}}} - 1).$$

Details on the parameterization of $\sigma_{out}$ are described in Appendix S1.

Note that Fraser River sockeye salmon are currently managed with a more conservative harvest control rule (total allowable mortality (TAM) rule), that accounts for cyclic abundance, overlapping run timings among MUs, en route mortality, and other system-specific management adjustments [@Pestal2011]. However the reference points associated with the TAM rule vary interannually and are informed by expert opinion, reducing its relevance to salmon fisheries in general. The TAM rule is summarized in Appendix S1 and we present the results of a secondary analysis comparing its performance to the generic HCR.

### 2.2.3 Alternative operating models

We evaluated the relative performance of different fishery allocations across two alternative operating models. First, we incorporated different productivity regimes by applying a scalar (0.6 to 1.1 in increments of 0.05) to $\alpha_{i}$. The scalar's bounds were based on observed productivity changes (mean ~30% decline, ranging from 54% decline to 53% increase) and represented hypothetical, additional future changes that might mirror those that have already occurred.

Second, we modeled the impact of single-stock harvest that occurred after en route mortality

Equation 7 $$ C_{sing,i,t} = (R'_{i,t} - C_{mix,i,t} - D_{i,t})u_{sing,i,t}. $$

Thus spawner abundance was calculated as

Equation 8 $$ S_{i,t} = R'_{i,t} - C_{mix,i,t} - D_{i,t} - C_{sing,i,t}. $$

This modification represents a scenario where single-stock fisheries are fully terminal. Terminal fishery impacts may be particularly relevant to aggregates such as Fraser River and Skeena River sockeye salmon where the large number of stocks with similar migration timing [@Grant2011; @Walters2008] will constrain other means of increasing selectivity. Since en route mortality in the Fraser River can be considerable in certain years [@Grant2011; @Cooke2004], the abundance of fish available to harvest will be lower in terminal fisheries relative to marine, altering trade-offs between conservation and catch objectives. 

Additionally, we completed sensitivity analyses to evaluate the impact of our assumptions about the magnitude of: temporal autocorrelation in recruitment deviations ($\tau$), error associated with estimating spawner abundance ($\sigma_{obs}$), outcome uncertainty ($\sigma_{out}$), and interannual variability in age-at-maturity ($\gamma$) and en route mortality ($\sigma_{mort}$) (Appendix S2).

### 2.2.4 Performance metrics

We considered a range of conservation- and catch-based performance metrics to determine how fishery allocations impact management performance (Table \@ref(tab:pmTable)). We evaluated both stock-specific and aggregate (i.e. summed or mean values within the MU) performance metrics. We present median outputs, as well as the 5th and 95th percentiles, among simulations for each performance metric.

```{r pmTable, results="asis"}
pmTable <- read.csv(here::here("data", "msTables", "pmTable.csv"))

k <- knitr::kable(pmTable, format = "pandoc", booktabs = TRUE, linesep = "",
                  caption = "Aggregate and stock-specific performance metrics.",
                  "latex") 
k <- kableExtra::kable_styling(k, font_size = 12)
k
```

We initialized the simulation with stock-specific time series of spawner and recruit abundance and ran the simulation for `r simPar[["simYears"]][1]` years (approximately `r round(simPar[["simYears"]][1]/4, 0)` generations). We summarized performance metrics across 1500 Monte Carlo trials (convergence occurred after approximately 1200). 