<!-- The following code should appear at the beginning of the first appendix.
After that, all subsequent sections will be turned into appendices. -->

`r if(knitr:::is_latex_output()) '\\Appendices'`

`r if(!knitr:::is_latex_output()) '# (APPENDIX) Appendix {-}'`

# Appendix S1 {#app:appendixS1}

## Larkin model

Cyclic salmon stocks are typically modeled using an adaptation of the Ricker model, the Larkin model, featuring delayed density-dependence parameters [@Larkin1971] 

Equation S1  $$log(\frac{R_{i,y}}{S_{i,y}}) = \alpha_i - \beta_iS_{i,y} - \beta_{1,i}S_{i,y-1} - \beta_{2,i}S_{i,y-2} - \beta_{3,i}S_{i,y-3} + w_{i,y}$$

where $i$ represents a stock, $y$ is a given brood year, $R$ the number of recruits, and $S$ the number of spawners. The parameter $\alpha$ represents the number of recruits produced per spawner at low abundance, while $\beta_{x}$ is the density-dependent parameter at time lag $x$. Stochastic recruitment deviations, $w_{i,y}$, are normally distributed with mean zero and variance $\sigma^2$.

## Recursive Bayes stock-recruit model

## Harvest control rules

As described in the main text, the simulation model generated target harvest rates (for both fisheries combined) using a generic, abundance-based harvest control rule (HCR) proposed under Fisheries and Oceans Canada's Precautionary Approach Framework [@DFO2017b]. Specifically a minimal exploitation rate (10%) approximating incidental harvest was applied when MU-level abundance was less than 40% of the spawner abundance that would lead to maximumum sustainable yield ($0.4{S}_{MSY}$). When abundance was greater than 80% of that spawner abundance ($0.8{S}_{MSY}$), the exploitation rate at maximum sustainable yield (approximated by ${u}_{MSY}$; Fig. \@ref(fig:genHCR)) was applied. When return abundance was between these two reference points, the target exploitation rate was a linear function of abundance (Fig. \@ref(fig:genHCR)).

```{r genHCR, warnings=FALSE, messages=FALSE, fig.cap="Generic, abundance-based harvest control rule used to calculate target exploitation rates. Dashed vertical lines represent lower (red) and upper (green) fishery reference points equivalent to $0.4{S}_{MSY}$ and $0.8{S}_{MSY}$, respectively. The maximum exploitation rate is equal to ${u}_{MSY}$."}
cuPar <- read.csv(here::here("data/summOnlyCUPars.csv"), stringsAsFactors = F)

uMsy <- cuPar$uMSY[1]
lowFRP <- cuPar$lowFRP[1]
highFRP <- cuPar$highFRP[1]

ret = seq(0, 2, length.out = 999)
esc = rep(NA, length.out = 999)
hr = rep(NA, length.out = 999)
for (i in 1:length(ret)) {
  if (ret[i] < lowFRP) {
    hr[i] <- 0.1
  }
  if (ret[i] > lowFRP & ret[i] < highFRP) {
    hr[i] <- max(0.1, 
                 uMsy * ((ret[i] - lowFRP) / (highFRP - lowFRP))
                 )
  }
  if (ret[i] > highFRP) {
    hr[i] <- uMsy
  }
  esc[i] <- ret[i] - (ret[i] * hr[i])
}

plot(hr ~ ret, xlim=c(0, 2), ylim=c(0, 1), ylab = "", xlab = "", axes = F, 
     type ="l", lwd = 2)
axis(1, las = 1)
axis(2, las = 1)
mtext("Total Exploitation Rate", 2, line = 2.5)
mtext("Return Abundance (Millions)", 1, line = 2)
abline(v = lowFRP, col = "red", lty = 2, lwd = 2)
abline(v = highFRP, col = "darkgreen", lty = 2, lwd = 2)
```

We also evaluated the impact of an alternative HCR, a total allowable mortality (TAM) rule, intended to approximate the management framework currently used for Fraser River sockeye salmon. As with the reference HCR, the TAM rule specifies annual target harvest rates based return abundance relative to two fishery reference points. Unlike the generic HCR, however, the TAM rule reference points differ vary among cycle lines, are derived using expert knowledge, and the maximum target harvest rates are lower (Table \@ref(tab:frpTable)).

```{r frpTable, results="asis"}
frpTable <- read.csv(here::here("data", "msTables", "frpTable.csv"))

csas_table(frpTable,
  caption = "Fishery reference points (FRP; in millions of fish) and maximum exploitation rates (ER) for the generic harvest control rule utilized in the main text and the total allowable mortality rule.",
  font_size = 20,
  col_names = c("Harvest Control Rule", "Cycle", "Low FRP", "High FRP", "Maximum ER")
)
```

The TAM rule also differs from the generic HCR due to two additional adjustments. First, harvest rates are typically lowered due to anticipated en-route mortality. We simulated this process by applying an en-route mortality adjustment, _pMA_, that acts as a scalar on escapement goals (i.e. a _pMA_ equal to 0 is no adjustment, equal to 1 is a 100% increase in the escapement goal). We parameterized this model component by setting the _pMA_ equal to the median _pMA_ observed for the Summer Run MU since 2000. Harvest rates are also adjusted annually to reduce incidental harvest of co-migrating MUs that are at low abundance. However, we excluded this adjustment because we only modeled one MU (Summer Run stocks).

# Appendix S2 {#app:appendixS2}

```{r loadData, include=FALSE}
listOfPackages <- c("tidyverse", "samSim", "pander")
lapply(listOfPackages, require, character.only = TRUE)

simPar <- read.csv(here::here("data", "manProcScenarios",
                        "fraserMPInputs_varyAllocationSens.csv"), 
                   stringsAsFactors = F) %>% 
  mutate(nameMP = paste(propMixHigh, singleHCR, "_", harvContRule, sep = ""))
cuPar <- read.csv(here::here("data/summOnlyCUPars.csv"), stringsAsFactors = F)

# Focal CUs and CU-specific PMs
summCUs <- cuPar %>% 
  filter(manUnit == "Summ") %>% 
  mutate(abbStkName = abbreviate(stkName, minlength = 4)) %>% 
  select(abbStkName) %>% 
  unlist()

# Summary sim data
plotDat <- read.csv(here::here("outputs", "generatedData", 
                               "sensAnalysisSummaryData.rds")) %>% 
  filter(mp == "0.5retro_genPA") %>% 
  mutate(scen = fct_relevel(scen, "rho", after = Inf)) %>% 
  mutate(scen = fct_relevel(scen, "enRouteSig", after = Inf)) 
  
```


##Multistock fishery harvest control rule##

_Move from main text based on co-author comments._

##En-route mortality##

_Move from main text based on co-author comments._

##Stochastic parameter sensitivity analyses##

We used local sensitivity analyses to evaluate how our conclusions may be impacted by the magnitude of interannual variation in stochastic parameters and temporal autocorrelation. For each parameter we selected upper and lower values (bounding plausible ranges; Table S1), held the remaining parameters constant, and compared distributions of performance metrics generated from 1500 Monte Carlo trials. We present results from a management procedure specifying equal allocations between mixed- and single-stock fisheries for all sensitivity scenarios. Additional analyses indicated that increasing the mixed-stock allocation increased the effect of mixed-stock fishery outcome uncertainty, while reducing the effect of single-stock outcome uncertainty. The opposite pattern occurred when single-stock fishery allocations were increased. Since the overall patterns remained similar these results are not shown.

To evaluate interannual variability in age-at-maturity and en-route mortality we applied scalars to $\gamma$ and $\sigma_{mort}$ cosnsitent with stock-specific differences (i.e. were within on standard deviation of observed values; Table S2). To evaluate the sensitivity of fishery-specific outcome uncertainty we set the lower value for $\sigma_{out}$ at zero (i.e. no deviations between target and realized catch) and the maximum value at 0.15, an arbitrary value resulting in ~20% of harvest rate deviations exceeding the maxmimum deviation observed among all Fraser River sockeye salmon management units between 2006 and 2017. Conversely, the reference $\sigma_{out}$ (0.07) results in ~0.2% of deviations exceeding the maximum observed. We applied the same minimum and maximum values to both single- and mixed-stock fisheries, but did so independently. Finally, we set the minimum temporal autocorrelation $\tau$ value at zero and the maximum at the largest estimated value from a study of Alaskan sockeye salmon [@Peterman2003].

```{r tableS2, results="asis"}
pars <- c("$\\gamma$", "$\\sigma_{out}$", "$\\sigma_{mort}$", "$\\tau$") 
refVals <- c(paste("stock-specific (range ", min(cuPar$tauCycAge), "-",
                max(cuPar$tauCycAge), ")", sep = ""),
          0.07,
          paste("stock-specific (range ", round(min(cuPar$sdDBE), 2), "-",
                round(max(cuPar$sdDBE), 2), ")", sep = ""),
          0.2)
minVals <- c("0.5 * ref. $\\gamma$", 0, "0.75 * ref. $\\sigma_{mort}$", 0)
maxVals <- c("1.25 * ref. $\\gamma$", 0.15, "1.25 * ref. $\\sigma_{mort}$",
             0.72)

sensPars <- data.frame(
  Parameter = pars,
  Reference = refVals,
  Minimum = minVals,
  Maximum = maxVals
)

csas_table(sensPars,
  caption = "Parameter values for components of operating model and management procedure that were adjusted in local sensitivity analyses.",
  font_size = 12,
  col_names = c("Parameter", "Ref. Value", "Min. Value", "Max. Value")
)
```

```{r generateData, include=FALSE}
vars <- c("medRecRY", "medSpawners", "ppnCULower", "medCatch", "stabilityCatch")

agDotPlotList <- lapply(seq_along(vars), function(x) {
  dum <- plotDat %>% 
    filter(var == vars[x],
           !scen == "genericRetro") 
  dumRef <- plotDat %>% 
    filter(var == vars[x],
           scen == "genericRetro")
  
  p <- ggplot(dum, aes(x = scen, y = avg, ymin = lowQ, ymax = highQ,
                       fill = om)) +
    labs(x = "", y = unique(dum$labelledVar)) +
    geom_pointrange(shape = 21, fatten = 4, size = 1,
                    position = position_dodge(width = 0.65)) +
    geom_hline(dumRef, mapping = aes(yintercept = avg), linetype = 1) +
    geom_hline(dumRef, mapping = aes(yintercept = lowQ), linetype = 2, 
               size = 0.5) +
    geom_hline(dumRef, mapping = aes(yintercept = highQ), linetype = 2, 
               size = 0.5) +
    scale_x_discrete(labels = c("ageTau" = "Mat.\nAge", 
                                "mixOU" = "Mixed\nOU", 
                                "singOU" = "Single\nOU",
                                "rho" = "Temp.\nAuto.", 
                                "enRouteSig" = "Mig.\nMort.")) + 
    scale_fill_discrete(name = "Operating\nModel",
                      labels = c("High\nVariability", "Low\nVariability"))
  if (unique(dum$pmClass) == "catch") {
    p <- p +
      theme_sleekX(position = "bottom", axisSize = 9, legendSize = 1)
  } else {
    p <- p +
      theme_sleekX(position = "top", axisSize = 9, legendSize = 1)
  }
  return(p)
})
```

The effects of greater variability differed among stochastic parameters and performance metrics. Greater outcome uncertainty within mixed-stock fisheries had the most consistent negative impact, with larger deviations between realized and target catch resulting in declines in all performance metrics (Fig. \@ref(fig:sensPlot)). Such patterns are consistent with evidence that outcome uncertainty can limit conservation and harvest objectives [@Holt2006]. Conversely, greater single-stock fishery outcome uncertainty had a relative modest impact, particularly on spawner abundance, because the single-stock fishery had zero harvest when abundance was low (Fig. \@ref(fig:sensPlot)). 

Greater temporal autocorrelation in recruitment deviations led to declines in recruitment, escapement, the proportion of stocks above their biological benchmark, and catch (Fig. \@ref(fig:sensPlot)). Such patterns are likely due to temporal autocorrelation weakening compensatory biological and management processes. Changes in interannual variability in maturation age and en route mortality rates had relatively minor effects on all performance metrics. Regardless of the performance metric, however, 90% quantile intervals for each sensitivity scenario overlapped the reference opearting model (Fig. \@ref(fig:sensPlot)). Since this pattern was stable when allocations were fully single- or fully mixed-stock, our conclusions are unlikely to be biased by the magnitude of stochastic parameters.

```{r sensPlot, warnings=FALSE, messages=FALSE, fig.cap="Sensitivity of conservation- and catch-based performance metrics to stochastic parameters and temporal autocorrelation. All scenarios assume a 50% of the total allowable catch was allocated to each fishery. Horizontal lines represent the median (solid) estimate and 90th percentile intervals (dashed) from the reference operating model. Points represent medians and whiskers represent 90th percentile intervals among Monte Carlo trials."}
library(ggpubr)
p <- ggarrange(agDotPlotList[[1]], agDotPlotList[[2]],
                               agDotPlotList[[3]], agDotPlotList[[4]],
                               agDotPlotList[[5]],
                               ncol = 3, nrow = 2, common.legend = TRUE,
                               legend = "right",
                               heights = c(0.85, 1))
p <- annotate_figure(p,
                bottom = ggpubr::text_grob("Proportion Mixed-Stock TAC",
size = 10, vjust = -1))
p
```
